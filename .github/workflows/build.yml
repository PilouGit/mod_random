name: Build mod_random

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

permissions:
  contents: write
  actions: read

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ubuntu-version: ['20.04', '22.04', '24.04']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y apache2-dev libapr1-dev cmake build-essential
    
    - name: Configure build
      run: |
        mkdir build
        cd build
        cmake ..
    
    - name: Build module
      run: |
        cd build
        make
    
    - name: Test module loads
      run: |
        cd build
        # Check if the module was built successfully
        test -f mod_random.so
        file mod_random.so
        ldd mod_random.so || true
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mod_random-ubuntu-${{ matrix.ubuntu-version }}
        path: |
          build/mod_random.so
          build/mod_random.load

  build-rockylinux:
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        dnf update -y
        dnf install -y httpd-devel apr-devel cmake gcc gcc-c++ make file
    
    - name: Configure build
      run: |
        mkdir build
        cd build
        cmake ..
    
    - name: Build module
      run: |
        cd build
        make
    
    - name: Test module loads
      run: |
        cd build
        # Check if the module was built successfully
        test -f mod_random.so
        file mod_random.so
        ldd mod_random.so || true
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mod_random-rockylinux-9
        path: |
          build/mod_random.so
          build/mod_random.load


  create-release:
    if: github.event_name == 'release' || github.ref == 'refs/heads/main'
    needs: [build-ubuntu, build-rockylinux]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Create release packages
      run: |
        # Create packages for each platform
        for dir in mod_random-*; do
          if [ -d "$dir" ]; then
            cd "$dir"
            tar -czf "../${dir}.tar.gz" *
            cd ..
          fi
        done
        ls -la *.tar.gz
    
    - name: Upload release assets
      uses: softprops/action-gh-release@v2
      with:
        files: "*.tar.gz"
        body: |
          ## mod_random Release
          
          This release includes pre-compiled binaries for:
          - Ubuntu 20.04, 22.04, 24.04
          - Rocky Linux 9
          
          ### Installation
          
          #### Linux
          1. Download the appropriate `.tar.gz` file for your distribution
          2. Extract: `tar -xzf mod_random-*.tar.gz`
          3. Copy `mod_random.so` to your Apache modules directory
          4. Copy `mod_random.load` to your Apache mods-available directory (if applicable)
          5. Enable the module: `a2enmod random`
          6. Restart Apache
          
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}